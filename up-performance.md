
## 薄荷商店首页接口性能优化记录  从 400+ ms 到 12ms

vincent <br> 2017-03-27

---

## 发现性能瓶颈

通过 newrelic 应用监控发现薄荷首页接口调用频繁，速度较慢，决定对其进行性能优化
首页请求量排在商店接口前 3 位，平均请求时间 400+ ms 以上，而首页是商店重要页面，速度慢很影响用户体验

---

## 初步问题剖析

使用 newrelic 提供的 profiling 信息了解到慢的主要原因，涉及数据很多，大量的数据查询
首页查询涉及 Homepage, Category, Label, Showcase, Goods 等多个个对象，查询语言很多，有近百个 SQL

---

## 使用对象缓存优化

根据首页特点，设计性能优化方案，主要是把首页涉及对象缓存到 Hash 对象中，重构代码测试发布，有比较好的效果
平均响应时间从 400+ ms 减低到 60 ms 左右

---

## 进一步 Profiling

对效果还不够满意，通过细致的 profiling 发现瓶颈在于大量 json 的编码解码
使用 ruby-pro profiling 发现 load json 和 dump json 花费时间很长，达 50 ms

---

## 进一步性能优化实施

设计使用 json 字符串缓存，巧妙构造 cache_key，完全避免数据库查询，同时引入 Etag 缓存，使最终性能优化达到非常理想效果

---

## 总结

 * 性能优化始于 benchmark，注重性能优化的性价比
 * 善于使用 profiling 工具，能够快速找到系统瓶颈
 * ruby json 操作速度慢，通过缓存 json 能够避免 ruby json 编码解码运算
 * 巧妙构造 cache_key，可完全避免数据库查询
 * 巧妙使用 Etag 缓存，可进一步提升优化效果
