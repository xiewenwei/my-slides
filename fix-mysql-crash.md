
# 修复 Mac 下 MySQL crash 问题

在去年金问号开发的时候就遇到过一个十分困扰的问题 - 运行测试的时候常常会报数据库连接错误，直到最近重新开始金问号的开发还是会遇到这个问题，经过一番研究总算解决了该问题，这周的技术分享简单记录一下。

这个问题的现象是当跑过几个金问号的测试后，就会出现连接 MySQL 报错的情况，无论是从 Rails 中连 MySQL 还是从 MySQL client 连都会出现报错，只有把 MySQL 强行关闭重新启动才又暂时解决问题，这个问题反复出现，大大降低开发效率。

一开始以为是 MySQL 本身的 Bug 导致，于是升级和降级 MySQL 试一试，发现问题依然存在。然后又以为是字符集的问题，因为金问号项目开始全面使用 utfmb4 字符集，和其它项目的数据库就这点明显不一样，但是把金问号的字符集更改为 utf8 后问题还是存在。

再次探查问题的时候偶然间想到也许是线程数或者文件句柄使用满了导致的问题。于是查看了 Mac 下打开文件限制和 MySQL 打开文件数，才发现果然这是问题的关键。Mac 下默认进程最多打开文件数有比较严格的限制，大概只有 256 个左右。MySQL 在 5.6 版本以后，默认使用每个表一个数据文件选项，当数据库的表比较多的时候很容易达到上限从而导致无法再打开新文件，从而无法建立新的连接。

知道原因之后解决方法就比较简单了，有两个方法：
1. 配置 MySQL 的表数据文件选项，innodb_file_per_table 设置为 off
2. 更改 Mac 进程打开文件数限制，比如由 256 上调到 2046
第一种方法相对比较简单，建议使用第一种方法，由此问题得到根本解决。
